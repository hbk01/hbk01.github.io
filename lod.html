<!DOCTYPE html>
<html lang="zh_CN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>干燥失重</title>
    <link rel="stylesheet" href="./github.css">
    <link rel="stylesheet" href="./theme.css">
    <script src="./decimal.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        var debug = false
        var localStorageSupport = storageAvailable("localStorage")
        var tip = `
<br>
操作过程：
<br>
空瓶 -> 干燥3小时 -> 冷却称重 -> 干燥1小时 -> 冷却称重(1) -> 加样(2) -> 干燥3小时 -> 冷却称重 -> 干燥1小时 -> 冷却称重(3)
<br>
<br>
记录保存功能使用方法：
<br>
保存：输入样品批号，点击保存，此时第一组及第二组输入框内的数据将被存储。
<br>
恢复：输入或选择样品批号，点击恢复，此时将读取对应数据并自动填入输入框。
<br>
删除：输入或选择样品批号，点击删除，此时将从已存储的数据中删除对应数据。
<br>
若保存、恢复、删除按钮均未显示，则表明您的浏览器不支持此功能。
`

        var decimal = Decimal.set({
            rounding: Decimal.ROUND_HALF_EVEN,
            precision: 12
        })

        $(document).ready(() => {
            $(".msgbox").append(tip)

            if (!localStorageSupport) {
                $("#remove").hide()
                $("#restore").hide()
                $("#save").hide()
                $("#lod-name").removeAttr("list")
            }

            if (localStorageSupport) loadSavedContentsList()

            // 若有前面页面的传值，则导入传入的值
            if (window.location.search.startsWith('?data')) {
                let data = getUrlParams('data').replaceAll('%22', '"')
                importData(JSON.parse(data))
            }

            $("#ok").click(() => {
                var m0l = $("#m0l").val()
                var m1l = $("#m1l").val()
                var m3l = $("#m3l").val()
                var m0r = $("#m0r").val()
                var m1r = $("#m1r").val()
                var m3r = $("#m3r").val()


                var lod1 = lod(m0l, m1l, m3l)
                var lod2 = lod(m0r, m1r, m3r)
                var average = decimal.add(lod1, lod2).div(2).toString()

                // TODO 可能干燥失重不应该使用 RSD 值来判断是否平行，可尝试使用 RD 或 RAD 判断
                // let rsd = RSD(lod1, lod2)

                var msg = `
第一组干燥失重 = ${lod1 <= 0 ? `<span style='color: red;'>${lod1}</span>` : lod1}<br>
第二组干燥失重 = ${lod2 <= 0 ? `<span style='color: red;'>${lod2}</span>` : lod2}<br>
两组干燥失重平均值 = ${average}<br>
${m0l != '' && m1l != '' ? `第一组恒重后空瓶+样 = ${decimal.add(m0l, m1l).toString()}` : ''}<br>
${m0r != '' && m1r != '' ? `第二组恒重后空瓶+样 = ${decimal.add(m0r, m1r).toString()}` : ''}<br>
`

                message(msg)
            })

            $("#clear").click(() => {
                if (!window.confirm("所填写的数据将被清空，确定？")) return
                $("#lod-name").val("")
                $("#m0l").val("")
                $("#m1l").val("")
                $("#m3l").val("")
                $("#m0r").val("")
                $("#m1r").val("")
                $("#m3r").val("")
                message(tip)
            })

            $("#new_page").click(() => {
                // 将当前页面的数据封装，并通过 URL 参数传递给新页面
                let data = JSON.stringify(exportData())
                let search = `?data=${data}`.replaceAll('"', '%22')
                let url = `${window.location.origin}${window.location.pathname}${search}`
                window.open(url, "_blank")
            })

            $("#save").click(() => {
                let id = $("#lod-name").val()
                if (id.length == 0) {
                    confirm("请输入或选择样品批号！")
                    return
                }

                // save data to localStorage
                let lod = exportData()
                lod['time'] = Date.now()
                localStorage.setItem(id, JSON.stringify(lod))
                loadSavedContentsList()
            })

            $("#restore").click(() => {
                let id = $("#lod-name").val()
                if (id.length == 0) {
                    confirm("请输入或选择样品批号！")
                    return
                }

                let lod = JSON.parse(localStorage.getItem(id))
                $("#m0l").val(lod.m0l)
                $("#m1l").val(lod.m1l)
                $("#m3l").val(lod.m3l)
                $("#m0r").val(lod.m0r)
                $("#m1r").val(lod.m1r)
                $("#m3r").val(lod.m3r)
            })

            $("#remove").click(() => {
                let id = $("#lod-name").val()
                if (id.length == 0) {
                    confirm("请输入或选择样品批号！")
                    return
                }
                if (confirm("确认删除 " + id + " 的数据？")) {
                    localStorage.removeItem(id)
                    loadSavedContentsList()
                    $("#lod-name").val("")
                    $("#clear").click()
                }
            })

            if (debug) {
                $("#m0l").val(18.34625)
                $("#m1l").val(1.04213)
                $("#m3l").val(19.38511)
                $("#m0r").val(21.23537)
                $("#m1r").val(1.00242)
                $("#m3r").val(22.23460)
            }
        })

        // 需要传递给新页面的数据
        function exportData() {
            let data = {
                "id": $("#lod-name").val(),
                "m0l": $("#m0l").val(),
                "m1l": $("#m1l").val(),
                "m3l": $("#m3l").val(),
                "m0r": $("#m0r").val(),
                "m1r": $("#m1r").val(),
                "m3r": $("#m3r").val(),
            }
            return data
        }

        // 需要导入哪些
        function importData(data) {
            // 对批号自增
            let id = data.id
            if (data.id.indexOf('-')) {
                let x = data.id.split('-')
                id = x[x.length - 1]
            }
            console.log(id)
            id = decimal.add(id, 1)
            if (data.id.indexOf('-')) {
                id = data.id.substring(0, data.id.lastIndexOf('-') + 1) + id
            }
            console.log(id)

            $("#lod-name").val(id)
            // 暂时不需要自动填充上一个页面传来的数据
            // $("#m0l").val(data.m0l)
            // $("#m1l").val(data.m1l)
            // $("#m3l").val(data.m3l)
            // $("#m0r").val(data.m0r)
            // $("#m1r").val(data.m1r)
            // $("#m3r").val(data.m3r)
        }

        function getUrlParams(key) {
            let params = window.location.search.substring(1).split("&")
            for (const v of params) {
                let pair = v.split("=")
                if (pair[0] == key) return pair[1]
            }
        }

        // 计算相对标准偏差
        // Markdown 公式：$RSD = \frac{SD}{\overline{x}}*100\%$
        function RSD(...array) {
            let stdev = STDEV(...array)
            let average = () => {
                let sum = new Decimal(0)
                array.forEach(value => sum = sum.plus(new Decimal(value)))
                return sum.dividedBy(array.length)
            }

            let rsd = stdev.dividedBy(average()).times(100)
            return rsd.toPrecision(5)
        }

        // 计算标准偏差
        // Markdown 公式：$SD = \sqrt{\frac{\sum_{i=1}^{n}(x_i - \overline{x})^2}{n-1}}$
        function STDEV(...array) {
            // 计算所有数值的和
            var sum = new Decimal(0)
            array.forEach(value => sum = sum.plus(new Decimal(value)))

            // 计算所有数值的平均值
            let average = sum.dividedBy(array.length)

            // 计算 ((每个数值减去平均值)的二次方)的和，即公式中分子的结果
            var sumEach = new Decimal(0)
            array.forEach(value => {
                let v = new Decimal(value)
                let temp = v.minus(average).toPower(2)
                sumEach = sumEach.plus(temp)
            })

            // 以上结果除以 n-1 并开根号即得
            let x = sumEach.dividedBy(array.length - 1).squareRoot()
            return x
        }

        function loadSavedContentsList() {
            // load data from localStorage to input.
            let keys = []
            $("#keys").empty()
            for (const key in localStorage) {
                if (Object.hasOwnProperty.call(localStorage, key)) keys.push(key)
            }
            keys.sort()
            keys.forEach(key => {
                let timestamp = JSON.parse(localStorage.getItem(key)).time
                let time = new Date(timestamp).format("yyyy-MM-dd hh:mm")
                let option = document.createElement("option")
                $(option).attr("value", key)
                $(option).attr("label", `保存于 ${time}`)
                $("#keys").append(option)
            })
        }

        // check storage available
        function storageAvailable(type) {
            let storage
            try {
                storage = window[type]
                const x = '__storage_test__'
                storage.setItem(x, x)
                storage.removeItem(x)
                return true
            }
            catch (e) {
                return e instanceof DOMException && (
                    // everything except Firefox
                    e.code === 22 ||
                    // Firefox
                    e.code === 1014 ||
                    // test name field too, because code might not be present
                    // everything except Firefox
                    e.name === 'QuotaExceededError' ||
                    // Firefox
                    e.name === 'NS_ERROR_DOM_QUOTA_REACHED') &&
                    // acknowledge QuotaExceededError only if there's something already stored
                    (storage && storage.length !== 0)
            }
        }

        function message(msg) {
            $(".msgbox").empty()
            $(".msgbox").append(msg)
        }

        /**
         * 计算干燥失重
         * @param m0 恒重后空瓶重
         * @param m1 样品重
         * @param m3 干燥恒重后带样品重
         * @return 干燥失重（%）
         */
        function lod(m0, m1, m3) {
            if (checkNull(m0, m1, m3)) {
                return "0"
            }

            let a = new Decimal(m0)
            let b = new Decimal(m1)
            let c = new Decimal(m3)

            // a + b - c / b
            let d = decimal.add(a, b).minus(c)
            let e = d.div(b).mul(100)
            return e.toString()
        }

        function checkNull(m0, m1, m3) {
            return m0 == '' || m1 == '' || m3 == ''
        }

        // 为 Date 创建日期格式化方法
        Date.prototype.format = function (fmt) {
            let o = {
                "M+": this.getMonth() + 1,                 //月份
                "d+": this.getDate(),                    //日
                "h+": this.getHours(),                   //小时
                "m+": this.getMinutes(),                 //分
                "s+": this.getSeconds(),                 //秒
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度
                "S": this.getMilliseconds()             //毫秒
            }
            if (/(y+)/.test(fmt)) {
                fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length))
            }
            for (var k in o) {
                if (new RegExp("(" + k + ")").test(fmt)) {
                    fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)))
                }
            }
            return fmt
        }

    </script>
</head>

<body>
    <h3>干燥失重</h3>
    <input type="text" name="lod-name" id="lod-name" list="keys" placeholder="样品批号"><br><br>

    <div class="one-team">
        第一组<br>
        <input type="number" name="m0l" id="m0l" class="one-input m0" placeholder="恒重后空瓶重(1)" inputmode="decimal"><br>
        <input type="number" name="m1l" id="m1l" class="one-input m1" placeholder="样品重(2)" inputmode="decimal"><br>
        <input type="number" name="m3l" id="m3l" class="one-input m3" placeholder="干燥恒重后带样品重(3)"
            inputmode="decimal"><br>
        <br>
    </div>

    <div class="two-team">
        第二组<br>
        <input type="number" name="m0r" id="m0r" class="two-input m0" placeholder="恒重后空瓶重(1)" inputmode="decimal"><br>
        <input type="number" name="m1r" id="m1r" class="two-input m1" placeholder="样品重(2)" inputmode="decimal"><br>
        <input type="number" name="m3r" id="m3r" class="two-input m3" placeholder="干燥恒重后带样品重(3)"
            inputmode="decimal"><br>
        <br>
    </div>

    <div class="buttons">
        <button id="new_page">新开标签页</button>
        <button id="clear">清除内容</button>
        <button id="ok">计算</button><br>

        <button id="remove">删除</button>
        <button id="restore">恢复</button>
        <button id="save">保存</button>
    </div>

    <div class="msgbox"></div>
    <datalist id="keys"></datalist>

</body>

</html>
